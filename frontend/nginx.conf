# linuxにnginxをインストールするとnginx.confが作成される
# コンテナ内で作成されるnginx.confを、ビルド時にfrontend/nginx.confで上書きする構成

server {
  listen 80;
  server_name _; # ホスト名のインバウンドルールで(_はどのホスト名でも受け入れる)

  # 静的配信（SPA）
  root /usr/share/nginx/html; # 指定パスにビルド成果物を配置して配信
  index index.html; # host:80/ にアクセスするとindex.htmlを返す

  # location / {...}で、/~にアクセスしたときの設定を記述
  # /file/pathにアクセス時、サーバーに物理ファイルが無い場合は/index.htmlを返す
  location / {
    # /file/path → /file/path/index.html → /index.htmlの順で返す
    try_files $uri $uri/ /index.html;
  }

  resolver 127.0.0.11 ipv6=off; # DNSリゾルバとして、Dockerの内部DNSを利用
  set $bff_upstream http://bff:80; # BFF upstream

  # location /bff/ {...}で、/bff/~にアクセスしたときの設定を記述
  location /bff/ {
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    # 変数付き proxy_pass では URI の置換が行われないため、末尾に /bff/ を付けない
    # リクエストの元の URI (/bff/...) をそのまま上流へ渡す
    proxy_pass $bff_upstream;
  }
}
